<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>âœï¸ Editor JerÃ¡rquico de Preguntas TAI</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #eef1f5;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    header {
      background: #007bff;
      color: white;
      width: 100%;
      text-align: center;
      padding: 1rem 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    main {
      width: 95%;
      max-width: 900px;
      background: #fff;
      border-radius: 10px;
      margin: 20px 0;
      padding: 20px 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    label { font-weight: bold; margin-top: 10px; display: block; }
    input[type=text], textarea, select {
      width: 100%; padding: 8px; margin-top: 4px;
      border-radius: 6px; border: 1px solid #ccc; font-size: 1em;
    }
    textarea { resize: vertical; }
    button {
      background: #007bff; color: #fff; border: none;
      padding: 10px 15px; border-radius: 6px; cursor: pointer;
      margin: 5px; font-size: 1em;
    }
    button:hover { background: #0056b3; }
    .btn-danger { background: #dc3545; }
    .btn-danger:hover { background: #b52a36; }
    .btn-secondary { background: #6c757d; }
    .btn-secondary:hover { background: #555e63; }
    .question-card {
      background: #f8f9fa; padding: 10px; border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 10px;
    }
    footer { text-align: center; margin: 20px; }
    a { margin: 10px; color: black; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <header>
    <h1>âœï¸ Editor JerÃ¡rquico de Preguntas TAI</h1>
    <a href="index.html" hover="color:red">ğŸ  Volver al Test</a>
    <a href="estadisticas.html">ğŸ“Š Ver EstadÃ­sticas</a>
  </header>

  <main>
    <form id="form">
      <label>Bloque:</label>
      <input type="text" id="bloque" placeholder="Ej: Bloque I" required>

      <label>Titulo:</label>
      <input type="text" id="titulo" placeholder="Ej: TÃ­tulo 1" required>

      <label>CapÃ­tulo (opcional):</label>
      <input type="text" id="capitulo" placeholder="Ej: CapÃ­tulo 1">

      <label>ArtÃ­culo (opcional):</label>
      <input type="text" id="articulo" placeholder="Ej: ArtÃ­culo 3">

      <label>Pregunta:</label>
      <textarea id="pregunta" rows="2" placeholder="Escribe la pregunta..." required></textarea>

      <label>Opciones:</label>
      <input type="text" id="opt1" placeholder="OpciÃ³n 1" required>
      <input type="text" id="opt2" placeholder="OpciÃ³n 2" required>
      <input type="text" id="opt3" placeholder="OpciÃ³n 3" required>
      <input type="text" id="opt4" placeholder="OpciÃ³n 4" required>

      <label>Respuesta correcta:</label>
      <select id="correcta">
        <option value="0">OpciÃ³n 1</option>
        <option value="1">OpciÃ³n 2</option>
        <option value="2">OpciÃ³n 3</option>
        <option value="3">OpciÃ³n 4</option>
      </select>

      <label>ExplicaciÃ³n (opcional):</label>
      <textarea id="explicacion" rows="2" placeholder="Por quÃ© es correcta..."></textarea>

      <button type="submit" id="guardar">ğŸ’¾ Guardar Pregunta</button>
      <button type="button" class="btn-secondary" id="limpiar">ğŸ§¹ Limpiar</button>
    </form>

    <hr>

    <div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px;">
      <button onclick="exportJSON()">â¬‡ï¸ Exportar JSON</button>
      <button onclick="importJSON()">â¬†ï¸ Importar JSON</button>
      <button class="btn-danger" onclick="clearAll()">ğŸ—‘ï¸ Borrar todas</button>
    </div>

    <hr>

    <div id="lista-preguntas"></div>
  </main>

  <footer>
    <a href="index.html">ğŸ  Volver al Test</a>
    <a href="estadisticas.html">ğŸ“Š Ver EstadÃ­sticas</a>
  </footer>

  <script>
    let preguntas = JSON.parse(localStorage.getItem("preguntasTAI") || "[]");
    let editIndex = null;

    function guardarEnLocal() {
      localStorage.setItem("preguntasTAI", JSON.stringify(preguntas));
      renderPreguntas();
    }

    document.getElementById("form").addEventListener("submit", e => {
      e.preventDefault();

      const titulos = [document.getElementById("bloque").value.trim(), document.getElementById("titulo").value.trim()];
      const capitulo = document.getElementById("capitulo").value.trim();
      const articulo = document.getElementById("articulo").value.trim();
      if (capitulo) titulos.push(capitulo);
      if (articulo) titulos.push(articulo);

      const nueva = {
        titulos,
        question: document.getElementById("pregunta").value.trim(),
        options: [
          document.getElementById("opt1").value.trim(),
          document.getElementById("opt2").value.trim(),
          document.getElementById("opt3").value.trim(),
          document.getElementById("opt4").value.trim()
        ],
        answer: parseInt(document.getElementById("correcta").value),
        explicacion: document.getElementById("explicacion").value.trim()
      };

      if (editIndex !== null) {
        preguntas[editIndex] = nueva;
        editIndex = null;
      } else {
        preguntas.push(nueva);
      }

      guardarEnLocal();
      e.target.reset();
      document.getElementById("guardar").textContent = "ğŸ’¾ Guardar Pregunta";
    });

    document.getElementById("limpiar").addEventListener("click", () => {
      document.getElementById("form").reset();
      editIndex = null;
      document.getElementById("guardar").textContent = "ğŸ’¾ Guardar Pregunta";
    });

    function renderPreguntas() {
      const cont = document.getElementById("lista-preguntas");
      cont.innerHTML = "";
      if (preguntas.length === 0) {
        cont.innerHTML = "<p>No hay preguntas guardadas.</p>";
        return;
      }

      preguntas.forEach((p, i) => {
        const card = document.createElement("div");
        card.className = "question-card";
        card.innerHTML = `
          <strong>${p.titulos.join(" > ")}</strong><br>
          ${p.question}<br>
          <em>âœ”ï¸ Correcta: ${p.options[p.answer]}</em><br>
          ${p.explicacion ? `<small>ğŸ’¡ ${p.explicacion}</small><br>` : ""}
          <button onclick="editar(${i})">âœï¸ Editar</button>
          <button class="btn-danger" onclick="borrar(${i})">ğŸ—‘ï¸ Eliminar</button>
        `;
        cont.appendChild(card);
      });
    }

    function editar(i) {
      const p = preguntas[i];
      document.getElementById("bloque").value = p.titulos[0] || "";
      document.getElementById("titulo").value = p.titulos[1] || "";
      // Compatibilidad: si el array tiene 4 elementos, [2]=capÃ­tulo, [3]=artÃ­culo
      if (p.titulos && p.titulos.length > 3) {
        document.getElementById("capitulo").value = p.titulos[2] || "";
        document.getElementById("articulo").value = p.titulos[3] || "";
      } else {
        // entradas antiguas: [bloque,titulo,articulo]
        document.getElementById("capitulo").value = "";
        document.getElementById("articulo").value = p.titulos[2] || "";
      }
      document.getElementById("pregunta").value = p.question;
      document.getElementById("opt1").value = p.options[0];
      document.getElementById("opt2").value = p.options[1];
      document.getElementById("opt3").value = p.options[2];
      document.getElementById("opt4").value = p.options[3];
      document.getElementById("correcta").value = p.answer;
      document.getElementById("explicacion").value = p.explicacion || "";
      editIndex = i;
      document.getElementById("guardar").textContent = "âœ… Actualizar Pregunta";
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function borrar(i) {
      if (confirm("Â¿Eliminar esta pregunta?")) {
        preguntas.splice(i, 1);
        guardarEnLocal();
      }
    }

    function clearAll() {
      if (confirm("Â¿Borrar todas las preguntas?")) {
        preguntas = [];
        guardarEnLocal();
      }
    }

    function exportJSON() {
      if (preguntas.length === 0) {
        alert("No hay preguntas para exportar.");
        return;
      }
      const fecha = new Date().toISOString().split("T")[0];
      const blob = new Blob([JSON.stringify(preguntas, null, 2)], { type: "application/json" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `preguntas_TAI_${fecha}.json`;
      link.click();
    }

    function importJSON() {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = ".json";
      input.multiple = true;
      input.onchange = e => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;
        
        let filesProcessed = 0;
        files.forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = evt => {
            try {
              const data = JSON.parse(evt.target.result);
              if (Array.isArray(data)) {
                data.forEach(q => {
                  if (!q.titulos && q.titulo) q.titulos = [q.titulo];
                });
                preguntas = preguntas.concat(data);
              } else {
                alert(`Archivo "${file.name}" no es un JSON vÃ¡lido.`);
              }
            } catch {
              alert(`Error al leer el archivo "${file.name}".`);
            }
            
            filesProcessed++;
            if (filesProcessed === files.length) {
              guardarEnLocal();
              alert(`âœ… Se importaron ${files.length} archivo(s) correctamente.`);
            }
          };
          reader.readAsText(file);
        });
      };
      input.click();
    }

    renderPreguntas();
  </script>
</body>
</html>
